# Antivirus Testing and Selection

## Introduction

This is a brief description of the tools I used, issues I encountered and results I found when testing multiple antivirus vendors.

I was brought into my current role as a system administrator for a company that previously did not have any dedicated IT department or managed service provider. The infrastructure was lacking and policies were not in place yet. On this surface, jumping into this type of role would seem sadistic at best to most IT professionals but it provided a great opportunity to learn a lot of different roles and wear lots of different hats. Plus, lets be real, anything I did would be an improvement and help the company overall by at least establishing a process.

My latest goal is to get some endpoint security solution rolled out to each of our endpoints. Given that this is my first sys admin role, my previous experience with antivirus solutions consisted of loading the free version of Malwarebytes on my parents computer and telling them to stop downloading every flash player they encountered. That being said, I try to attend local B Sides instances whenever possible. So I at least had some introduction to live malware samples. I also am subscribed to /r/hacking so I’m pretty much an expert.

Lets introduce the contenders in this review. There were 4 main vendors I was evaluating. MalwareBytes, Sophos, CrowdStrike and Cylance. Now, if you go talk to them, they will all give you a nice demo and their sales pitch. They will have a nice collection of malware samples and will let you pick out which you would like run and even sometimes show how their competitors stack up to the same sample. I think if you’re reading this, you most likely can spot why this is mostly a waste of time and a marketing tactic for less tech savvy potential clients or possibly people who just don’t care enough to take a step further. I won’t claim to have an special testing abilities or even an entry level knowledge of malware. But, I do believe in at least an effort towards the scientific method, some basic organization and planning can go a long way. So let’s jump in.

This also ended up my first time actually installing High Sierra on VirtualBox. Lets just say Apple did not make this user friendly. Standing on the shoulders of giants is more or less how I live my life though, so after several Google searches I found some very helpful articles. I started with this [Caffeine Security article](https://blog.caffeinesecurity.com/creating-a-macos-high-sierra-vm-for-virtualbox-mac-host-bb67eada27af) which ended up having a couple other articles embedded in it that, when pieced together, got me a running instance of High Sierra to test from. I did also need to employ [this article](http://osxdaily.com/2017/09/27/download-complete-macos-high-sierra-installer/) to actually get the full High Sierra instance instead of just the installer.  I would love to say I checked all those hashes and verified the programs I downloaded like a good sys admin and tech professional but considering it was all going on a machine that was now forever being used for malware testing, I didn’t care. I made one running virtual machine and then just copied it three more times so I would have the same instance for each vendor being tested. I also took the time to load on Wireshark or any other tools I thought I might want before copying the image.  

Lets chat about the samples themselves. I dont have any honeypots running or places I can pull live samples from and quite frankly we haven’t had any major breaches with anything serious. Queue the Google searches again (also shoutout to the local infosec slack channel for pointing me in the direction of some of these). Here are the two spots I pulled form:
* https://github.com/ytisf/theZoo
* https://objective-see.com/malware.html

Now I realize that AV vendors can easily find these samples and protect against them, but its about the best I can do with my resources (time frame and actual manpower) and I feel like its at least doing my due diligence. Since these are publicly facing samples, if the antivirus did not detect it that would certainly raise some red flags for me. Below I have basically copy and pasted the report I wrote up for my COO with any sensitive information removed.

## Requirements

A quick note about the results. I had very little time to run this test. It was very much a "rush to get it done so you can wait" situation. Had I known that I would have spent significantly more time building out the requirements and testing procedures as well as looking into each sample and remediation efforts a bit more. It was what it was, however, so we will go forward with what I have. There were four initial requirements for whatever antivirus vendor was selected to move forward with the sales process. The requirements are a nature of the current technical environment.

1. The antivirus solution had to support Apple and macOS based products and the company must have specific provisions for this operating system.
2. The solution must have a cloud hosted console and not require any on premise equipment required. Currently we do not host any servers on site, and therefore we do not want to deploy additional network infrastructure specifically for one software platform if at all avoidable. Cloud hosted solutions will allow for additional administrator users and scalability as the company and department grows without adding additional overhead resources needed.  
3. The product must have endpoint sensors that are deployable through the current asset management system, Addigy. This can be in the form of an .app or .pkg file.
4. The product that is placed on each endpoint must not be resource intensive on the end user’s machine. This is both a matter of hardware resources used, but also the amount of presence visible to the end user on the machine. Lower end user visibility is considered to be advantageous in this instance.

I specifically selected the particular solutions that were tested because they met these standards to at least some degree. The resting would then bring to light which ones would fare best in each scenario.

## Procedures

The purpose of the testing procedures was to provide an identical environment for all four of the platforms to be deployed to. The environment needed to be isolated and properly contained given the nature of the malware that would be intentionally deployed. The High Sierra operating system was selected as the test environment since this is the most prevalent operating system version among our users (currently approximately 75% of our users are on a version of High Sierra).

A new copy of the High Sierra operating system was obtained from Apple’s App Store to ensure validity of the installation. This file was then was created into an appropriate image to be loaded into a VirtualBox instance. A copy of WireShark was also installed to each image in order to allow for packet inspection should there be an resulting issues form the malware installed. Malware samples were obtained from security researcher and professional Patrick Wardle.

A separate instance of a virtual machine was created for each vendor. This would ensure no persistent malware or antivirus files would conflict with the next vendor’s results. The machines were not allowed host to guest clipboard or shared folders in order to minimize opportunities for infection of the host machine. The virtual instances were allowed internet connectivity in order to allow for the download of samples.

Once samples were obtained, they were ran locally on the virtual instance. If permissions were required or any extensions were blocked by macOS’s native configuration, permissions were granted manually and the script or program was allowed to run. This was to ensure that all vendors had an equal opportunity to detect and quarantine or remove any malicious programs or files it found.

The solutions would be judged based on their ability to detect and prevent the running of the malicious code. They would also be evaluated on the actions taken on the end user’s machine and how much interference it caused to user’s daily activities and workflow. I used a simple PASS or FAIL result for each sample introduced. If there was a significant delay in the time between when the malicious code was run and the program reported a detection, it would be reported as DELAYED. There was a fourth option for if the malware sample was unable to be run. This would be noted with a NO RUN result. A no run result could be a result of a bad or incomplete sample or if macOS XProtect prevented the sample from being run because it matched a yara signature on the host’s OS.

All of the samples introduced are publicly available and are not 0 day exploits. All of the vendors should have had ample opportunity to provide solutions for preventing the execution of the malicious code.

## Results

![Image](https://github.com/phaughney22/chickenscratch/blob/master/avresult.png)   

The results of the tests helped to set apart some of the products from their peers. Both Sophos and Crowdstrike were able to identify and mitigate all of the samples that were tested. Cylance seemed to do fairly well addressing the threats. However, in some cases it was slow to respond or in one instance failed to identify a threat in any reasonable amount of time. It did receive a couple of delayed responses because it eventually did block the program from running, however it was able to run prior to being blocked.

Malwarebytes seemed to have a difficult time with the tests. In many cases the samples were not reported as a threat by Malwarebytes. I inquired about the poor performance and lack of detection from an individual at Malwarebytes who was not part of the sales process and was unaware of any deals between our two companies. He mentioned that often times Malwarebytes will deem a threat out of date and no longer actively update signatures or look for the threat. This proved to be the downfall of it in this case. I believe, that while these threats are not 0 day vulnerabilities or the most current advanced threats, they still are present in the threat landscape today and should at least be protected against. Deeming a threat “outdated” is relying on security via time-based obscurity and in my opinion is a poor practice. For this reason I would suggest eliminating Malwarebytes from contention.

Additional samples were tested on both Crowdstrike and Sophos but were not featured in the above infographic for spaces sake and because they passed all samples thrown. Because of their performance, price point and feature I will suggest moving forward with either Sophos or Crowdstrike, with a preference towards Crowdstrike despite their price difference that will be addressed in a subsequent section.

## Vendor Specific Notes for Top Performers

Sophos stood out as a solid contender in two major departments. It mitigated all risks that were presented to it and it comes in as the cheapest option available. However, their features are fairly basic in terms of administration and they do have a presence with the end user. I would prefer to have a solution that does not have an end user presence because all threats will notify an administrator anyways, and notifying the end user as well causes undue panic and a second notification to the administrator resulting in additional resource usage. The other major difference between Sophos and Crowdstrike is that Sophos develops their product to continually scan all files on the computer in search of threats. Admittedly this did help it score well in detection tests, but it is significantly more resource intensive than the alternative approach of detection used by Crowdstrike.

Crowdstrike performed equally as well as Sophos in detecting and mitigating risk. It does come with a cost premium, however. The cost premium I feel is justified by a more complete and well thought out product offering. Notifications to end users can be turned off while still alerting administrators should there be a threat introduced to the machine. This allows the administrator to take necessary action while allowing the user to continue working without unnecessary concern or knowledge. Crowdstrike also offers a myriad of additional modules that can be purchased and added to the platform should the business grow or need to scale accordingly. While these are not necessary at this point, the availability of them without having to change platforms again should be considered given the rapid growth character of our company. Another major area where Crowdstrike excels is in the performance approach. While Sophos attempts to continually scan every file, Crowdstrike only scans code that is attempting to be executed. This drastically reduces the performance impact on an end machine while still allowing for the same detection ability. Crowdstrike also has put considerable effort into their detection engine in order to also include behavioral detection. This allows for the sensor on a given machine to detect threats that have not yet been seen if the executed code behaves in ways that are abnormal or malicious to the system.
